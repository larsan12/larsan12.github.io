<html>
  <head>
    <title></title>
    <meta content="">
    <style>
        label {
            margin-right: 30px;
            margin-left: 10px;
        }
        div {
            border: 1px dotted black;
        }
    </style>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script type="text/javascript">
        var data, fullData, changeInput, dataSelected, changeRadio

        var inputs = ["Americas", "Africa", "Asia", "Europe", "Oceania"];
        var ignoredFields = ["alpha2_code", "latitude", "longitude", "total_export_value", "total_import_value", "years", "top_partners"]

        // for Aggregations
        var agregation = ["none", "continent"];
        var folded_fields = ["population", "gdp"];
        var average_fields = ["life_expectancy"];
        var constant_fields = ["year"];



        function draw(data) {
            d3.select("body").append("div").attr("class", "conditions")
            drawInputs()
            drawRadio()
            drawTable(data)
        }

        //FILTERS
        function drawInputs() {
            var div = d3.select("div.conditions").append("div").attr("class", "inputs").text(() => "Filter by: ");
            inputs.forEach(input => {
                let lable = div.append("label").text(() => input+ ": ")
                lable.append("input")
                    .attr("type","checkbox")
                    .attr("title",input)
                    .attr("value",input)
                    .attr("name",input)
                    .attr("onchange", "changeInput()");
            })

            changeInput = () => {
                clearRadio();
                let names = [];
                d3.select("div.inputs").selectAll("input").each(function(d) {
                    // Current name of the checkbox is d3.select(this).attr("name")
                    if (d3.select(this).property("checked")) {
                        names.push(d3.select(this).attr("name"))
                    }
                })

                if (names.length == 0)
                    names = inputs;
                dataSelected = data.filter(row => names.indexOf(row.continent) != -1)
                dropTable()
                drawTable(dataSelected)
            }

        }

        function clearInputs() {
            d3.select("div.inputs").selectAll("input").each(function(d) {
                d3.select(this).property("checked", false)
            })
        }


        //SLIDER
        let drawSlider = () => d3.select("div.conditions")
        .append("div")
        .attr("class", "slider")
        .append("label")
        .text(d => "Time update: ")
        .append("input")
        .attr("type", "range")
        .attr("class", "points")
        .attr("min", 1995)
        .attr("max", 2012)
        .attr("step", 1)
        .attr("value", 2012)
        .attr("oninput", "changeYear()")

        function changeYear() {
            let value = d3.select("input.points").property("value");
            filteredData = fullData.map(country => ({
                ...country,
                years: undefined,
                ...country.years.find(year => year.year == value),
                top_partners: undefined
            }))
            data = filteredData;
            dropTable()
            drawTable(data)
        }


        //AGGREGATOR

        function drawRadio() {
            var div = d3.select("div.conditions").append("div").attr("class", "radio").text(() => "Aggregation: ");

            agregation.forEach(agr => {
                let lable = div.append("label").text(() => agr+ ": ")
                lable.append("input")
                    .attr("type","radio")
                    .attr("value", agr)
                    .attr("name", "Aggregation")
                    .attr("onchange", "changeRadio()");
            })

            changeRadio = () => {
                let property = "";

                d3.select("div.radio").selectAll("input").each(function(d) {
                    if (d3.select(this).property("checked")) {
                        property = d3.select(this).attr("value")
                    }
                })

                if (property == "none" || !property) {
                    dropTable()
                    drawTable(data)
                } else {
                    var aggregation = d3.nest()
                      .key(d => d[property])
                      .rollup(rows => {
                          let group = {}
                          Object.keys(rows[0]).forEach(prop => {
                              if (folded_fields.indexOf(prop) != -1) {
                                  group[prop] = d3.mean(rows, r => r[prop])
                              } else if (average_fields.indexOf(prop) != -1) {
                                  group[prop] = d3.mean(rows, r => r[prop] * r["population"])/d3.mean(rows, r => r["population"])
                              } else if (constant_fields.indexOf(prop) != -1) {
                                  group[prop] = rows[0][prop]
                              } else {
                                  group[prop] = rows[0][property]
                              }
                          })
                          return group
                      })
                      .entries(data)
                      .map(obj => obj.values)

                      dropTable()
                      drawTable(aggregation)
              }

              clearInputs();

            }
        }

        function clearRadio() {
            d3.select("div.radio").selectAll("input").each(function(d) {
                d3.select(this).property("checked", false)
            })
        }


        //TABLE
        function dropTable() {
            d3.select("table").remove()
        }

        function drawTable(data) {
            data.map(row => {
                ignoredFields.forEach(w => delete row[w])
            })
            var columns = Object.keys(data[0]);

            var table = d3.select("body").append("table"),
            thead = table.append("thead")
            .attr("class", "thead");
            tbody = table.append("tbody");

            table.append("caption")
            .html("World Countries Ranking");

            thead.append("tr").selectAll("th")
            .data(columns)
            .enter()
            .append("th")
            .text(function(d) { return d; })
            .on("click", function(header, i) {
                tbody.selectAll("tr").sort(function(a, b) {
                    if (a[header] == b[header]) {
                        return d3.descending(a["name"], b["name"]);
                    } else {
                        return d3.descending(a[header], b[header]);
                    }
                });
                acceptZebra()
            });

            let currentValue = "white";

            //formatt
            var lifeFormat = d3.format(",.1f");
            var defaultFormat = d3.format(",")
            var gdpFormat = d3.format(",.")

            var rows = tbody.selectAll("tr.row")
            .data(data)
            .enter()
            .append("tr").attr("class", "row")

            var cells = rows.selectAll("td")
            .data(function(row) {
                return d3.range(Object.keys(row).length).map(function(column, i) {
                    if (Object.keys(row)[i] == "life_expectancy") {
                        return lifeFormat(row[Object.keys(row)[i]])
                    } else if (Object.keys(row)[i] == "gdp") {
                        return gdpFormat(Math.ceil(row[Object.keys(row)[i]]))
                    } else  if (Object.keys(row)[i] == "population") {
                        return defaultFormat(row[Object.keys(row)[i]])
                    } else {
                        return row[Object.keys(row)[i]];
                    }
                });
            })
            .enter()
            .append("td")
            .text(function(d) { return d; })
            .on("mouseover", function(d, i) {

                let row = d3.select(this.parentNode)
                currentValue = row.style("background-color")
                row.style("background-color", "#F3ED86");

            }).on("mouseout", function() {

                d3.select(this.parentNode).style("background-color", currentValue);

            });

            //zebra pattern accept
            function acceptZebra() {
                tbody.selectAll("tr")
                .each(function(d, i) {
                    if (i % 2 == 0) {
                        d3.select(this).style("background-color", "#99ccff")
                    } else {
                        d3.select(this).style("background-color", "white")
                    }
                })
            }

            acceptZebra()

        }

        //DATA HANDLER

        loadData = (str) => new Promise ((resolve, reject) => {
            var XHR = ("onload" in new XMLHttpRequest()) ? XMLHttpRequest : XDomainRequest;
            var xhr = new XHR();
            xhr.open('GET', str, true);

            xhr.onload = function() {
                resolve(JSON.parse(this.responseText))
            }
            xhr.onerror = function() {
              reject(this.status)
            }
            xhr.send();
        })

        loadData("https://larsan12.github.io/countries_2012.json").then(data => {
            data = data
            draw(data)
        })

        loadData("https://larsan12.github.io/countries_1995_2012.json").then(data => {
            fullData = data
            drawSlider()
        })


    </script>
  </head>
  <body>

  </body>
</html>
